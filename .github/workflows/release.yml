name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: read

jobs:
  # ===========================================================================
  # Build: default variant (Go generator only)
  # ===========================================================================
  build-default:
    uses: albertocavalcante/actions/.github/workflows/go-build.yml@240c86b5ff0b76efbbcbcd1781116753e80fb9d5 # main 2026-02-09
    with:
      binary-name: lspls
      go-version: "1.25"
      platforms: "linux-amd64,linux-arm64,darwin-amd64,darwin-arm64,windows-amd64"
      artifact-prefix: lspls
    permissions:
      contents: read

  # ===========================================================================
  # Build: full variant (all generators)
  # ===========================================================================
  build-full:
    uses: albertocavalcante/actions/.github/workflows/go-build.yml@240c86b5ff0b76efbbcbcd1781116753e80fb9d5 # main 2026-02-09
    with:
      binary-name: lspls-full
      go-version: "1.25"
      module-path: "./cmd/lspls"
      build-tags: "lspls_full"
      platforms: "linux-amd64,linux-arm64,darwin-amd64,darwin-arm64,windows-amd64"
      artifact-prefix: lspls-full
    permissions:
      contents: read

  # ===========================================================================
  # Release: download all artifacts, generate notes, create GitHub release
  # ===========================================================================
  release:
    needs: [build-default, build-full]
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Download all artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          path: release-assets
          merge-multiple: true

      - name: List release assets
        run: ls -la release-assets/

      - name: Generate release notes
        id: notes
        uses: albertocavalcante/actions/release-notes@240c86b5ff0b76efbbcbcd1781116753e80fb9d5 # main 2026-02-09
        with:
          version: ${{ github.ref_name }}
          assets-dir: release-assets
          project-name: lspls
          project-description: "LSP Protocol Type Generator"
          is-prerelease: ${{ contains(github.ref_name, '-') }}

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ github.ref_name }}
        run: |
          PRERELEASE_FLAG=""
          if [[ "$TAG" == *"-"* ]]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          gh release create "$TAG" \
            --title "$TAG" \
            --notes "${{ steps.notes.outputs.release-notes }}" \
            $PRERELEASE_FLAG \
            release-assets/*
