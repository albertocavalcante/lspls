# Lefthook configuration for pre-commit hooks
# https://github.com/evilmartians/lefthook
#
# Install: lefthook install
# Run manually: lefthook run pre-commit

pre-commit:
  parallel: true
  commands:
    # Check Go formatting
    gofmt:
      glob: "*.go"
      run: |
        unformatted=$(gofmt -l {staged_files})
        if [ -n "$unformatted" ]; then
          echo "The following files are not formatted:"
          echo "$unformatted"
          echo ""
          echo "Run 'gofmt -w .' or 'just format' to fix"
          exit 1
        fi

    # Check go.mod is tidy
    go-mod-tidy:
      glob: "*.go"
      run: |
        go mod tidy
        if ! git diff --quiet go.mod go.sum; then
          echo "go.mod or go.sum is not tidy"
          echo "Run 'go mod tidy' and commit the changes"
          git diff go.mod go.sum
          exit 1
        fi

    # Verify Go build
    go-build:
      glob: "*.go"
      run: go build ./...

    # Run Go tests (short mode for speed)
    go-test:
      glob: "*.go"
      run: go test -short ./...

pre-push:
  parallel: true
  commands:
    # Full test suite with race detection
    go-test-full:
      run: go test -race ./...

    # Lint check (uses tools.go.mod)
    lint:
      run: go tool -modfile=tools.go.mod golangci-lint run --config=tools/lint/golangci.toml

# Output settings
output:
  - meta
  - summary
  - success
